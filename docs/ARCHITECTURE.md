# Architecture Documentation

*Last Updated: April 2025*

This document outlines the system architecture of the Yellow Letter Shop (YLS) platform. It describes the application layers, data interactions, request flows, Stripe authorization mechanics, and supporting systems that power proof review, AI personalization, team collaboration, rollback tools, short link tracking, saved payment methods, webhooks, and scheduled reports.

---

## 1. System Overview

YLS is a cloud-native, modular SaaS platform for managing and automating direct mail campaigns. It supports address validation, print customization, proof approval, skip tracing, vendor routing, per-field audit tracking, scheduled reports, webhook logs, and team collaboration.

---

## 2. High-Level Architecture

```
[Client Browser] --> [Next.js App Router]
                    |         |
                    v         v
           [API Routes]    [FPD Editor + UI]
                |               |
          [Supabase DB]    [Supabase Storage]
                |               |
[Stripe] [AccuZIP] [Mailgun] [OpenAI/Claude] [Webhook APIs]
                |
     [Audit Engine + Rollback + Report Engine + Payment Flow]
```

---

## 3. Application Layers

### A. Frontend
- Next.js App Router
- Tailwind CSS components
- Modules:
  - Order Wizard
  - Campaign Scheduling
  - Contact Card Manager
  - Proof Annotation Viewer
  - Stored Payment Method Manager
  - Feedback UI (NPS)
  - Webhook Dashboard
  - Team Access Controls
  - Report Builder + Download Viewer

### B. API Layer
- Next.js API Routes
- RESTful endpoints
- Authenticated with Supabase JWT + NextAuth
- Input validation via Zod
- Stripe integration (manual capture)
- Routes organized by module: `/api/orders`, `/api/reports`, `/api/feedback`, `/api/records`, `/api/payments`, etc.

### C. Database Layer
- Supabase PostgreSQL with full RLS
- Prisma schema for typed data access
- Key tables:
  - `orders`, `mailing_list_records`, `record_field_changes`
  - `user_payment_methods`, `skip_trace_orders`, `scheduled_reports`
  - `audit_logs`, `webhook_logs`, `proof_annotations`, `feedback`, `short_links`

### D. File Storage
- Supabase Storage (S3-backed)
- Buckets:
  - `uploads/`, `designs/`, `template-previews/`, `order-proofs/`, `skip-trace/`

### E. Third-Party Integrations
- Stripe (manual capture authorization + stored cards)
- AccuZIP (address validation)
- OpenAI/Claude (AI personalization prompts)
- Mailgun or SendGrid (proofs, skip trace files, reports)
- Webhook delivery (custom + Zapier-compatible)

---

## 4. Payment Authorization Architecture

1. **User reaches final screen of order wizard.**
2. Stripe `payment_intent` is created with `capture_method = manual`.
3. Payment is **authorized but not captured.**
4. Order moves to `awaiting_proof` status.
5. Once the user approves proofs:
   - Capture is triggered via Stripe
   - Status updates to `approved â†’ printing`
6. If the user cancels before approval:
   - `payment_intent` is canceled or expires
   - Funds are released, no charge occurs

### Stripe Data Storage:
- `orders.payment_intent_id` is required
- `user_payment_methods` table stores Stripe PMs
- Users can manage their cards under Account Settings

---

## 5. Record Change Tracking & Rollback

- Every mailing list edit is logged in `record_change_logs` and `record_field_changes`
- Admin and users can preview before/after field-level diffs
- Rollback can be performed:
  - Per record
  - Per tag group
  - Entire list batch
- All rollback activity is logged to `audit_logs`

---

## 6. Stored Payment Method Architecture

- Stripe customer and PMs stored at user level
- API supports add, delete, set default
- Used to prefill checkout and save new cards at time of payment intent creation
- User may opt to save or remove cards securely

---

## 7. Proof & Annotation System

- PDF proofs generated by vendor or admin
- Uploaded to `order-proofs/`
- Shown in embedded React-PDF viewer
- Users annotate with % coordinates and text
- Threads can be resolved, replied to, and reviewed by admin

---

## 8. Webhook Infrastructure

- Event types: `order_created`, `proof_approved`, `skip_trace_completed`, `short_link_clicked`
- Each endpoint is user-configurable
- Retry supported via UI + CRON queue
- Logs stored in `webhook_logs` with full payload and response
- Admin reporting dashboard shows delivery rate

---

## 9. Reporting Engine

- Reports can be generated on demand or scheduled
- Formats supported: CSV, PDF, Excel
- Delivered via email or download
- Scheduled report metadata stored in `scheduled_reports`
- Logged to `audit_logs` with delivery status

---

## 10. Team Collaboration Layer

- Users can invite others to shared teams
- `team_members` table tracks access
- Assets shared:
  - Lists, orders, contact cards, designs, reports
- Roles enforced: admin, manager, user
- Admin can impersonate or revoke access

---

## 11. Feedback Capture Layer

- Triggered after proof approval or report delivery
- NPS + comment stored in `feedback`
- Scores under 6 alert support team
- Feedback is included in admin analytics

---

## 12. Short Link Tracking

- `short_links` are generated per record
- Redirects log access event (IP, timestamp, user agent)
- Used in campaign analytics
- Feed displayed in user dashboard and reporting

---

## 13. Observability & Logs

| Type             | Location             |
|------------------|----------------------|
| API Errors       | Sentry               |
| Payment Events   | Stripe Logs          |
| Auth / Access    | Supabase Logs        |
| File Storage     | Supabase Audit       |
| Short Link Hits  | `short_links`        |
| Feedback Scores  | `feedback`           |
| Webhook Events   | `webhook_logs`       |
| Field Changes    | `record_field_changes`|
| Audit Actions    | `audit_logs`         |

---

## Contact

For architecture support, infra planning, or scale concerns:  
support@yellowlettershop.com

